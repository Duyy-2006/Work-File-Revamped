if not game:IsLoaded() then
    repeat game.Loaded:Wait() until game:IsLoaded()
end
wait(30)
task.spawn(function()
    -- ================== SERVICES ==================
    local ws          = game:GetService("Workspace")
    local Players     = game:GetService("Players")
    local VIM         = game:GetService("VirtualInputManager")
    local HttpService = game:GetService("HttpService")

    local LocalPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()
    local lp          = LocalPlayer

    -- GUI cố định (không cần tìm lại mỗi vòng)
    local playerGui   = LocalPlayer:WaitForChild("PlayerGui")
    local hud         = playerGui:WaitForChild("HUD")
    local main        = hud:WaitForChild("Main")
    local currencies  = main:WaitForChild("Currencies")

    local TARGET_NAME = "Iced Tea"

    -- Các biến sẽ được cập nhật mỗi vòng
    local Level        = nil
    local Gold         = nil
    local TraitRerolls = nil
    local Gems         = nil
    local CakeSlices   = nil
    local IcedTea      = nil

    -- ================== HELPER: urlencode ==================
    local function urlencode(str)
        str = tostring(str or "")
        str = str:gsub("\n", " ")
        return str:gsub("([^%w%-_%.~ ])", function(c)
            return string.format("%%%02X", string.byte(c))
        end):gsub(" ", "%%20")
    end

    -- ================== GOOGLE SHEET CONFIG ==================
    local GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbwqQgPRFOvWwGgOux-a34HA8pJUqb5myzRCfjAjG1SKG6O71cktwficpf7Zc_dYwiE/exec"

    local function getRequestFunc()
        if syn and syn.request then return syn.request end
        if http and http.request then return http.request end
        if http_request then return http_request end
        if request then return request end
        return nil
    end

    local function sendToGoogleSheet()
        local req = getRequestFunc()
        if not req then
            warn("[Sheet] No HTTP request function found (syn.request/http_request/request)")
            return
        end

        local timestamp = os.date("%Y-%m-%d %H:%M:%S")

        local level        = Level        or ""
        local gold         = Gold         or ""
        local traitRerolls = TraitRerolls or ""
        local gems         = Gems         or ""
        local cakeSlices   = CakeSlices   or ""
        local icedTea      = IcedTea      or ""

        local url = GOOGLE_SHEET_URL
            .."?timestamp="    .. urlencode(timestamp)
            .."&username="     .. urlencode(lp.Name)
            .."&level="        .. urlencode(level)
            .."&gold="         .. urlencode(gold)
            .."&traitRerolls=" .. urlencode(traitRerolls)
            .."&gems="         .. urlencode(gems)
            .."&cakeSlices="   .. urlencode(cakeSlices)
            .."&icedTea="      .. urlencode(icedTea)

        local ok, res = pcall(req, {
            Url = url,
            Method = "GET"
        })

        if ok then
            print("[Sheet] Sent to Google Sheet. Status:", res.StatusCode or res.Status or "N/A")
            print("[Sheet] Body:", res.Body or res.body or "NO BODY")
        else
            warn("[Sheet] Failed to send:", res)
        end
    end

    --============ Check xem trong HUD.Main.Currencies đã có child "IcedTea" chưa ============--
    local function hasIcedTeaChild()
        for _, currencyFrame in ipairs(currencies:GetChildren()) do
            if currencyFrame.Name == "CurrencyFrame" then
                local amount = currencyFrame:FindFirstChild("Amount")
                if amount and amount:FindFirstChild("IcedTea") then
                    return true
                end
            end
        end
        return false
    end
    local RS = game:GetService("ReplicatedStorage")

    -- cache remote để dùng lại
    local CurrencyDisplayEvent

    local function getCurrencyDisplayEvent()
        -- Nếu đã tìm được trước đó và nó vẫn còn trong game → dùng lại
        if CurrencyDisplayEvent and CurrencyDisplayEvent.Parent then
            return CurrencyDisplayEvent
        end

        local remote

        -- 1) Thử path đơn giản: ReplicatedStorage.Networking.CurrencyDisplayEvent
        local ok, err = pcall(function()
            local networking = RS:FindFirstChild("Networking") or RS:WaitForChild("Networking", 10)
            if networking then
                remote = networking:FindFirstChild("CurrencyDisplayEvent")
            end
        end)

        if not ok then
            warn("[IcedTea] Error while looking for Networking:", err)
        end

        -- 2) Nếu vẫn chưa thấy, search toàn bộ ReplicatedStorage theo Name
        if not remote then
            for _, inst in ipairs(RS:GetDescendants()) do
                if inst.Name == "CurrencyDisplayEvent" then
                    remote = inst
                    break
                end
            end
        end

        if remote then
            CurrencyDisplayEvent = remote
            print("[IcedTea] Bound CurrencyDisplayEvent:", remote:GetFullName(), "Class:", remote.ClassName)
        else
            warn("[IcedTea] CurrencyDisplayEvent remote not found in ReplicatedStorage")
        end

        return CurrencyDisplayEvent
    end

    --============ Đảm bảo IcedTea đã được bật (nếu chưa thì bấm Configure + toggle) ============--
       --============ Đảm bảo IcedTea đã được bật ============--
        --============ Đảm bảo IcedTea đã được bật ============--
        --============ Đảm bảo IcedTea đã được bật ============--
    local function ensureIcedTea()
        if hasIcedTeaChild() then
            print("[IcedTea] Đã tồn tại trong HUD.Main.Currencies")
            return true
        end

        print("[IcedTea] Chưa thấy child 'IcedTea', gọi CurrencyDisplayEvent...")

        local remote = getCurrencyDisplayEvent()
        if not remote then
            warn("[IcedTea] Không tìm được CurrencyDisplayEvent, bỏ qua.")
            return false
        end

        local ok, err = pcall(function()
            -- theo log: arg[1] = "Toggle", arg[2] = "IcedTea"
            remote:FireServer("Toggle", "IcedTea")
        end)

        if not ok then
            warn("[IcedTea] FireServer failed:", err)
            return false
        end

        -- Đợi HUD update, check lại vài lần
        for i = 1, 20 do  -- ~2 giây
            if hasIcedTeaChild() then
                print("[IcedTea] Đã thấy child 'IcedTea' sau khi FireServer")
                return true
            end
            task.wait(0.1)
        end

        warn("[IcedTea] Vẫn không thấy 'IcedTea' trong HUD.Main.Currencies sau khi FireServer")
        return false
    end



    -- Bật IcedTea một lần lúc đầu
    ensureIcedTea()

    -- ============ LOOP MỖI 120 GIÂY ============ --
    while true do
        -- ----- LẤY Level từ workspace -----
        local chars       = ws:WaitForChild("Characters")
        local playerChar  = chars:WaitForChild(lp.Name) -- hoặc lp.Name nếu muốn auto
        local torso       = playerChar:WaitForChild("Torso")
        local tag         = torso:WaitForChild("Tag")
        local level       = tag:WaitForChild("Level")
        local levelAmount = level:WaitForChild("Amount")

        print("Workspace Level Amount.Text =", levelAmount.Text)
        Level        = levelAmount.Text
        Gold         = nil
        TraitRerolls = nil
        Gems         = nil
        CakeSlices   = nil
        IcedTea      = nil

        -- ----- LẤY x + Amount.Text Ở GUI CURRENCIES -----
        for _, currencyFrame in ipairs(currencies:GetChildren()) do
            if currencyFrame.Name == "CurrencyFrame" then
                local amount = currencyFrame:FindFirstChild("Amount")
                if amount then
                    local ok, amountText = pcall(function()
                        return amount.Text
                    end)

                    if ok then
                        for _, child in ipairs(amount:GetChildren()) do
                            if child.Name ~= "UIStroke" then
                                local name = child.Name
                                print(name .. " + " .. amountText)

                                if name == "Level" then
                                    Level = amountText
                                elseif name == "Gold" then
                                    Gold = amountText
                                elseif name == "TraitRerolls" then
                                    TraitRerolls = amountText
                                elseif name == "Gems" then
                                    Gems = amountText
                                elseif name == "CakeSlices" then
                                    CakeSlices = amountText
                                elseif name == "IcedTea" then
                                    IcedTea = amountText
                                end
                            end
                        end
                    else
                        warn("Amount không có thuộc tính Text trong: " .. currencyFrame:GetFullName())
                    end
                else
                    warn("CurrencyFrame không có child 'Amount': " .. currencyFrame:GetFullName())
                end
            end
        end

        -- ----- DEBUG + GỬI SHEET -----
        print("== Collected Variables ==")
        print("Level       =", Level)
        print("Gold        =", Gold)
        print("TraitRerolls=", TraitRerolls)
        print("Gems        =", Gems)
        print("CakeSlices  =", CakeSlices)
        print("IcedTea     =", IcedTea)

        sendToGoogleSheet()

        -- chờ 120 giây
        task.wait(120)
    end
end)
